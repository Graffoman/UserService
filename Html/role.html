<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Роль</title>
    <link rel="stylesheet" href="css/main.css">   
</head>
<body>
    <div class="menu">
        <ul>
            <li><a href="listrole.html">Пользователи</a></li>
            <li><a href="listgroup.html">Группы</a></li>
            <li><a href="listrole.html">Роли</a></li>
        </ul>
    </div>
    <div class="main-role-form">
        <div class="editorcontainer">
            <h2>Данные роли</h2>
            <input type="text" id="roleid" name="roleid" value="" hidden />
        </div>
        <div>
            <label for="rolename">Наименование:</label>
            <input type="text" class="text" id="rolename" name="rolename" />
        </div>        
    </div>
    <div class="roleformtable">
        <h2>Пользователи</h2>
        <table class="table" name="usertable" id="usertable">
            <thead>
                <tr>
                    <th>Фамилия</th>
                    <th>Имя</th>
                    <th>Отчество</th>
                    <th>Подразделение</th>
                    <th>E-mail</th>
                    <th></th>
                </tr>
            </thead>
            <tbody name="usertbody" id="usertbody">
            </tbody>
        </table>
    </div>

    <script>
        const roleid = localStorage.getItem('roleid');

        async function loadroleinfo(loadroleid) {
            let url = "https://localhost:5101/api/Role/" + loadroleid;

            let response = await fetch(url, {
                method: "GET",
                headers: { "Content-Type": "application/json" }
            });

            if (response.ok === true) {
                let role = await response.json();
                document.getElementById("rolename").value = role.name;
            }
            else {
                let error = await response.json();
                console.log(error.message);
            }
            
            let urluserlist = "https://localhost:5101/api/Role/userlist?id=" + loadroleid;
            
            let responseuserlist = await fetch(urluserlist, {
                method: "POST",
                headers: { "Content-Type": "application/json" }                
            });

            if (responseuserlist.ok === true) {
                let users = await responseuserlist.json();
                let userrows = document.getElementById("usertbody");
                users.forEach(user => userrows.append(userrow(user)));
            }
            else {
                let error = await responseuserlist.json();
                console.log(error.message);
            }

        }

        function userrow(user) {

            let tr = document.createElement("tr");
            tr.setAttribute("data-rowid", user.id);

            let lastnameTd = document.createElement("td");
            lastnameTd.append(user.lastName);
            tr.append(lastnameTd);

            let nameTd = document.createElement("td");
            nameTd.append(user.name);
            tr.append(nameTd);

            let middlenameTd = document.createElement("td");
            middlenameTd.append(user.middleName);
            tr.append(middlenameTd);

            let departmentTd = document.createElement("td");
            departmentTd.append(user.department);
            tr.append(departmentTd);

            let emailTd = document.createElement("td");
            emailTd.append(user.email);
            tr.append(emailTd);

            /*
            let linksTd = document.createElement("td");
         
            const removeLink = document.createElement("button");
            removeLink.append("Удалить");
            removeLink.addEventListener("click", async () => await deleteUser(user.id));
         
            linksTd.append(removeLink);
            tr.appendChild(linksTd);
            */

            let linksTd = document.createElement("td");

            const editLink = document.createElement("button");
            editLink.append("Подробнее");
            editLink.className = "button";
            editLink.addEventListener("click", async () => await edituser(user.id));

            linksTd.append(editLink);
            tr.appendChild(linksTd);

            return tr;
        }

        function edituser(userid) {
            localStorage.setItem('userid', userid);
            window.location.href = 'user.html';
        }

        window.onload = function () {
            if (roleid != null) {
                document.getElementById("roleid").value = roleid;

                loadroleinfo(roleid);
            }


        }

    </script>

    <!--<script src="js/role.js"></script>-->
</body>
</html>